from fastapi import APIRouter, Depends
from pymongo.database import Database
from app.db.mongo_client import get_db
from app.services.poll_status_service import PollStatusService

router = APIRouter()

@router.post("/poll-status")
def poll_status(request: Dict[str, str], db: Database = Depends(get_db)):
    """
    Polls the processing status of each step based on the given request_id.
    """
    request_id = request.get("request_id")
    if not request_id:
        return {
            "status": "error",
            "message": "Missing request_id in request payload"
        }

    service = PollStatusService(run_logs_col=db["run_request_logs"])
    return service.get_step_status(request_id)
